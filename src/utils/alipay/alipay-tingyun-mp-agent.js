/*AGENT_VERSION=1.3.8*/"use strict";var i=my;function m(){return+new Date}function a(t){var e=i.getStorageSync({key:t});return e&&e.data}function r(t,e){i.setStorageSync({key:t,data:e})}function t(){var t=i.getSystemInfoSync();return t&&(t.SDKVersion=i.SDKVersion),t}function y(t){return t.status}function e(){return["tradePay","scan","previewImage"]}var n=[],v={context:null},s={networkType:"",system:t()};function o(t){n.push({timestamp:m(),route:t})}function c(){n=[]}function u(){return n.slice()}function d(e){return function(t){return"Array"===e&&Array.isArray?Array.isArray(t):Object.prototype.toString.call(t)==="[object "+e+"]"}}var h=d("String"),f=d("Array"),g=d("Function"),T=d("Object"),l=d("Boolean"),p=d("Number");function D(t,e){return function(){if(g(e))try{e.apply(this,arguments)}catch(t){}if(g(t))return t.apply(this,arguments)}}function q(e,n,a){return function(){var t;if(g(n))try{n.apply(this,arguments)}catch(t){}if(g(e)&&(t=e.apply(this,arguments)),g(a))try{a.apply(this,arguments)}catch(t){}return t}}function S(t,e){var n,a,r;T(t)&&g(t.handler)&&(n=t.name,a=t.handler,r=t.afterHandler,e[n]=q(e[n],a,r),e[n]._ty_hook=!0)}var x=function(){function t(t){return t<0?NaN:t<=30?0|Math.random()*(1<<t):t<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<t-30))*(1<<30):NaN}function e(t,e){for(var n=t.toString(16),a=e-n.length,r="0";0<a;a>>>=1,r+=r)1&a&&(n=r+n);return n}return function(){return e(t(32),8)+"-"+e(t(16),4)+"-"+e(16384|t(12),4)+"-"+e(32768|t(14),4)+"-"+e(t(48),12)}}();function b(t){return t&&h(t)?JSON.parse(t):t}function I(t){try{return b(t)}catch(t){}return null}function k(t,e){var n="",a=!1;try{n=JSON.stringify(t)}catch(t){a=!(n="")}return e?{error:a,value:n}:n}function E(t){return t+""}function A(t){return t?T(t)?k(t).length:h(t)?t.length:t instanceof ArrayBuffer?t.byteLength:t.length?t.length:0:0}function O(t,e){var n=T(t)?k(t):h(t)?t:"";return e&&(n=n.substring(0,e)),n}var _="recordTyTime",C="TINGYUN_UID",F="custom",L="TRIGGER_LIFECYCLE",R=20,M="event",P="request",N="api",w="timer",j=1500,H=!0,z=!0,Y=5,B="TY_CONFIG",K="TY_SAMPLING",G="TY_SETDATA_THRESHOLD",U="TY_SETDATA_TRACE",V="TY_SETDATA_TRACEHINT",J="TY_IGNORE_ERRCODES",X="TY_SETDATA_TIME_INTERVAL",Q=[500,1500],W=256,Z=256,$="__ty_page_param",tt={},et=!1;function nt(t){null==(tt=t||{}).requestFailMessageSize&&(tt.requestFailMessageSize=Z),null==tt.apiFailMessageSize&&(tt.apiFailMessageSize=W)}function at(){return et}function rt(t){et=t}function it(){for(var t=0;t<arguments.length;t++)if(null!=arguments[t])return arguments[t]}function st(t){this.size=t||100,this.queue=[],this.running=!1}st.prototype.add=function(t){this.queue.length>=this.size||(this.queue.push(t),this.running||(this.running=!0,this.run()))},st.prototype.run=function(){var t=this;this.handler(this.queue.shift(),function(){0<t.queue.length?t.run():t.running=!1})},st.prototype.handler=function(t,e){var n={url:"".concat(tt.beacon).concat(t.uri),method:t.method||"POST",_no_record:!0,success:function(){t.success&&t.success.apply(this,arguments)},fail:function(){t.fail&&t.fail.apply(this,arguments)},complete:function(){t.complete&&t.complete.apply(this,arguments),e()}};t.data&&(n.data=t.data),i.request(n)};var ot=new st,ct=6e5,ut=mt(K),dt=!1;function ht(t){return null!=t&&p(t)}function ft(t){return null!=t&&l(t)}function lt(t){return null!=t&&f(t)}function pt(t){return lt(t)&&2==t.length}function mt(t){var e=a(B);if(e&&T(e))return e[t]}function yt(t){var e=a(B);if(e&&T(e)||(e={}),t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r(B,e)}function vt(t,r){var i=this,s={};t.forEach(function(t){var e=t.key,n=t.storeKey,a=t.validFunc;!!a&&a.call(i,r[e])&&(tt[e]=r[e],s[n]=r[e])}),yt(s)}function gt(t){tt.key&&tt.beacon&&ot.add({uri:"/mp-config/config/pullSampling?encodeMpId=".concat(tt.key),success:function(t){var e,n=t.data||{},a=n.data;200===n.code&&a&&(ht(a.sampling)&&(ut=a.sampling,(e={})[K]=ut,yt(e)),vt([{key:"setdataThreshold",storeKey:G,validFunc:ht},{key:"setdataTrace",storeKey:U,validFunc:ft},{key:"setdataTraceHint",storeKey:V,validFunc:ft},{key:"ignoreErrorCodes",storeKey:J,validFunc:lt},{key:"setdataTimeInterval",storeKey:X,validFunc:pt}],a))},complete:function(){t&&t(ut)}})}function Tt(){ut=ut||(+tt.sampleRate||1);var t=Math.random();dt=t<=ut}function Dt(){return{uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[],setData:{threshold:it(tt.setdataThreshold,mt(G),j),setDataTrace:it(tt.setdataTrace,mt(U),H),setDataTraceHint:it(tt.setdataTraceHint,mt(V),z),setDataTimeInterval:it(tt.setdataTimeInterval,mt(X),Q),stuck:!1,max:0,currentSegmentTime:0,data:{},requestBridge:[]},reqStat:{currentSegmentTime:0,data:{}},lastSetDataInOnReady:0,stuck:!1,jsError:!1,netError:!1,recordFirstLoad:!1}}function qt(){return{stuck:!1,firstLoad:0,jsError:!1,netError:!1}}setInterval(gt,ct);var St={},xt=[],bt=0,It={},kt=Dt(),Et=qt(),At={canSend:!1,sent:!1,apiRemain:0,needClearDeferredData:!1};function Ot(){St={},xt=[],bt=0,At.apiRemain=0,kt=Dt(),At.needClearDeferredData=!0}function _t(){Et=qt()}function Ct(t){var e;kt.eventActions||(kt.eventActions=[]),kt.otherActions||(kt.otherActions=[]),t&&(t.type===M?(e=tt&&tt.eventMaxSize||R,kt.eventActions&&kt.eventActions.length>=e&&kt.eventActions.shift(),kt.eventActions.push(t)):kt.otherActions.push(t))}function Ft(t,e){for(var n in e)e.hasOwnProperty(n)&&e[n]&&0<e[n].count&&t.push(Object.assign(e[n]||{},{timestamp:+n}))}function Lt(){var t=[],e=[];Ft(t,kt.setData.data),Ft(e,kt.reqStat.data);var n,a,r={metric:{jsError:xt&&0<xt.length,netError:kt.netError,stuck:kt.stuck}};return 0<t.length&&(r.setData={threshold:it(kt.setData.threshold,j),setDataTrace:it(kt.setData.setDataTrace,H),setDataTraceHint:it(kt.setData.setDataTraceHint,z),setDataTimeInterval:it(kt.setData.setDataTimeInterval,Q),max:kt.setData.max,requestBridge:kt.setData.requestBridge,data:t}),0<e.length&&(r.reqStat=e),!St.onLoad||(a=(a=kt.lastSetDataInOnReady)||St.onReady)&&(n=0<(n=a-St.onLoad)?n:0,r.metric.firstLoad=n),Et=r.metric,r}function Rt(){bt=m()}var Mt={uid:Pt(),sid:x(),v:"1.3.8",at:"my"};function Pt(){var t=a(C);return t||(t=x(),r(C,t)),t}function Nt(t){var e;dt&&((e=Object.assign({},Mt,s||{},{key:tt.key},t||{})).launch=!t,e.launch&&(e.launchOptions=v.launchOptions),ot.add({uri:"/mp-app",data:e}))}function wt(t){var e,n;dt&&(L===t&&(At.canSend=!0),!At.sent&&At.canSend&&(e=Object.assign({},{path:It.current,pageEvent:Object.assign({},St),errs:xt.slice(),fromPath:It.prev||"",actions:(kt.eventActions||[]).concat(kt.otherActions||[])},Object.assign({},Mt,s||{},{key:tt.key}),0<bt?{ct:bt}:{},Lt()),(n=u())&&(e.routeTrack=n),ot.add({uri:"/mp-page",data:e}),Ot(),At.sent=!0,At.canSend=!1))}function jt(t){Tt();var e=t.path,n=t.query,a=t.scene;s.openPath=e,tt.disableFetchQuery||(s.query=n),s.scene=a,v.launchOptions=t,i.getNetworkType({success:function(t){s.networkType=t.networkType},complete:function(){Nt()}})}function Ht(t){var e,n="",a="";h(t)?n=t:t&&(n=t.stack,a=t.message),n&&(e={time:m(),stack:n},a&&(e.msg=a),xt.push(e))}function zt(){var t=u();c();var e=It.current;It.prev="",It.current="",Nt({routeTrack:t,closePath:e,metric:Et})}function Yt(){return!0}var Bt=[{name:"onLaunch",handler:jt},{name:"onError",handler:Ht},{name:"onHide",handler:zt}];function Kt(e){return Bt.forEach(function(t){S(t,e)}),e}function Gt(t){return t}function Ut(){var e=App;App=function(t){if(t=Kt(t),e)return e.call(this,t)}}function Vt(t){return tt.ignoredPages&&f(tt.ignoredPages)?tt.ignoredPages.indexOf(t)<0:!tt.pages||!f(tt.pages)||-1<tt.pages.indexOf(t)}function Jt(t,e){if(!T(e))return t;try{var n=Object.keys(e).map(function(t){return"".concat(t,"=").concat(e[t])}).join("&");n&&(t+="?".concat(n))}catch(t){}return t}function Xt(){var c=this.setData,u=kt.setData.threshold,d=kt.setData.setDataTrace,h=kt.setData.setDataTraceHint,f=kt.setData.setDataTimeInterval;this.setData=function(){var a=arguments[0],r=arguments[1],t=m(),i={start:t},s=v.context,o=s&&s.type===P&&s.data&&s.data.recordFirstLoad;(kt.recordFirstLoad||o)&&(i.calcFirstLoad=!0);try{var e=kt.setData.currentSegmentTime;1e3<t-e?(kt.setData.currentSegmentTime=t,kt.setData.data[t]={count:0,grade:{good:{count:0},normal:{count:0},bad:{count:0}},traces:[]},i.segmentTime=t):i.segmentTime=e}catch(t){}function n(){try{i.end=m(),i.calcFirstLoad&&i.end>kt.lastSetDataInOnReady&&(kt.lastSetDataInOnReady=i.end),i.duration=i.end-i.start;var t=kt.setData.data[i.segmentTime];if(t.count++,i.duration>kt.setData.max&&(kt.setData.max=i.duration),i.duration>f[1]?t.grade.bad.count++:i.duration>f[0]?t.grade.normal.count++:t.grade.good.count++,i.duration>u&&(kt.stuck||(kt.stuck=!0),t.traces.length<Y&&d))try{var e=k(a,!0),n={timestamp:i.start,duration:i.duration,size:e.value.length};h&&(n.hint=e.value.substring(0,200)),e.error&&(n.error=e.error),t.traces.push(n)}catch(t){}o&&kt.setData.requestBridge.push({start:i.start,end:i.end,requestId:s.data.requestId,url:s.data.url})}catch(t){}return r&&r.apply(this,arguments)}return c.call(this,arguments[0],n)}}function Qt(){Vt(this.route)&&(At.needClearDeferredData&&(_t(),At.needClearDeferredData=!1),kt.recordFirstLoad=!0,Xt.call(this),St.onLoad=m(),this[$]=Jt(this.route,arguments[0]))}function Wt(){var t;Vt(this.route)&&(At.needClearDeferredData&&(_t(),At.needClearDeferredData=!1),St.onShow=m(),o(t=this[$]||this.route),It.prev=It.current,It.current=t,At.sent=!1)}function Zt(){Vt(this.route)&&(St.onReady=m())}function $t(){Vt(this.route)&&(kt.recordFirstLoad=!1)}function te(){Vt(this.route)&&(St.onHide=m(),wt(L))}function ee(){Vt(this.route)&&(St.onUnload=m(),wt(L))}var ne=[{name:"onLoad",handler:Qt},{name:"onShow",handler:Wt},{name:"onReady",handler:Zt,afterHandler:$t},{name:"onHide",handler:te},{name:"onUnload",handler:ee}];function ae(t,e){for(var n in t){var a;t.hasOwnProperty(n)&&g(t[n])&&!t[n]._ty_hook&&g(e)&&(a=t[n],t[n]=e.call(this,n,a),t[n]._ty_hook=!0)}}var re=[P,N,w];function ie(){var e={};return re.forEach(function(t){e[t]={current:0,children:0}}),e}function se(t,e){for(var n=0;n<t.length;n++)if(t[n].cid===e.id){e.requests&&0<e.requests.length&&(t[n].requests=e.requests),e.apis&&0<e.apis.length&&(t[n].apis=e.apis);break}}function oe(t){t=t||{},this.id=++kt.uniqueId,this.parent=t.parent||null,this.name=t.name||"<root>",this.type=t.type||M,this.subType=this.type===M?t.subType||"tap":t.subType,this.requests=[],this.apis=[],this.remain=ie(),this.s=m(),this.e=null,this.data=t.data,this.closed=!1,this.path=It.current,this.prevPath=It.prev,this.dataComposed=t.dataComposed||!1}oe.prototype.end=function(t){var e;this.closed||(t&&((e=this.getItemsByType(t.type))&&0<e.length&&se(e,t),this.updateRemain(-1,t.type)),this.isNoRemain()&&(this.e=m(),this.closed=!0,this.parent?this.parent.end(this):(Ct(this.composeActionData()),v.context=null)))},oe.prototype.getItemsByType=function(t){var e;return t===P?e=this.requests:t===N&&(e=this.apis),e},oe.prototype.isNoRemain=function(t){var e=!0;for(var n in this.remain){if(this.remain.hasOwnProperty(n))if(!(this.remain[n].current<=0&&(!!t||this.remain[n].children<=0))){e=!1;break}}return e},oe.prototype.setData=function(t){this.data=t},oe.prototype.hasPrevAssignedData=function(){return this.requests&&0<this.requests.length||this.apis&&0<this.apis.length},oe.prototype.composeActionData=function(){var t={id:this.id,name:this.name,type:this.type,start:this.s,end:this.e,duration:0<this.e-this.s?this.e-this.s:0,path:this.path,prevPath:this.prevPath};return this.requests&&0<this.requests.length&&(t.requests=this.requests),this.apis&&0<this.apis.length&&(t.apis=this.apis),this.data&&(t.data=this.data),this.type!==P&&this.type!==N||(delete(t=Object.assign({},t,this.data)).data,this.type===P&&delete t.name),t},oe.prototype.canEnd=function(){return this.isNoRemain(!0)},oe.prototype.isEventChildContext=function(){for(var t=this.parent,e=!1;null!=t;){if(t.type===M){e=!0;break}t=t.parent}return e},oe.prototype.updateRemain=function(t,e){e=e||P;var n=t||0;this.remain[e].current=this.remain[e].current+n;for(var a=this.parent;a;)a.remain[e].children=a.remain[e].children+n,a=a.parent},Object.defineProperty(oe.prototype,"current",{get:function(){return v.context},enumerable:!0,configurable:!0});var ce="tyname";function ue(t){return!t||"tap"!==t.type||!T(t.target)||!T(t.currentTarget)||null==t.timeStamp}function de(t,e){var n,a=t.target||{},r=a.offsetLeft,i=a.offsetTop,s=a.id,o=a.dataset,c=t.detail||{},u=c.x,d=c.y;t._relatedInfo&&(n=t._relatedInfo.anchorTargetText);var h={target:{offsetLeft:r,offsetTop:i,id:s,x:u,y:d},dataset:{name:o[ce],targetName:n,methodName:e}},f=e||"";v.context=new oe({name:f,type:M,subType:t.type,data:h,dataComposed:!0})}function he(){v.context&&v.context.canEnd()&&v.context.end(),v.context=null}function fe(a,r){return function(){var t,e=arguments[0]||{},n=ue(e);if(!n)try{de.call(this,e,a)}catch(t){}try{t=r.apply(this,arguments)}finally{if(!n)try{he.call(this)}catch(t){}}return t}}function le(e){var n=v.context;return function(){var t;v.context=n;try{t=e.apply(this,arguments)}finally{v.context=null}return t}}function pe(e){return ne.forEach(function(t){S(t,e)}),ae(e,fe),e[_]=Rt,e}function me(t){return t}function ye(){var e=Page;Page=function(t){if(t=pe(t),e)return e.call(this,t)}}function ve(t){v.context=t.context}function ge(){v.context&&v.context.canEnd()&&v.context.end()}var Te=i.request;function De(t,e){if(!t)return null;var n=null,a=I(t["X-Tingyun-Tx-Data"]);return a&&a.r&&E(a.r)===E(e)&&(n=a),n}function qe(t,e){tt.id&&(t.header["X-Tingyun-Id"]="".concat(tt.id,";r=").concat(e.r))}function Se(t){if(!t)return 0;var e=t.header,n=t.data,a=0;return(a=+(e&&e["Content-Length"]))&&p(a)&&!Number.isNaN(a)||(a=A(n)||0),a}function xe(t,e){var n={},a=De(t.header,e.r);return a&&(n.s_id=a.id,n.s_name=a.action,a.time&&(n.s_du=a.time.duration,n.s_qu=a.time.qu),n.t_id=a.trId),n}function be(t,e,n){return{requestId:t.requestId,type:P,url:t.url,method:t.method,start:t.start,end:t.end,cbTime:t.cbTime,duration:0<t.end-t.start?t.end-t.start:0,send:A(e.data),rec:Se(n),statusCode:t.statusCode||0,failMessage:t.failMessage||"",cid:t.cid}}function Ie(t,e){var n;t.context||(n="".concat(t.url,"-").concat(t.requestId),t.context=new oe({parent:e,name:n,type:P,data:t.data}))}var ke=function(t){var e,n,a,f,r,i,l,p=t||{};return!p._no_record&&p.url&&at()&&(1e3<(e=m())-(n=kt.reqStat.currentSegmentTime)&&(n=e,kt.reqStat.currentSegmentTime=e,kt.reqStat.data[e]={count:0}),kt.reqStat.data[n].count++,a=v.context,(f={requestId:++kt.requestId,url:p.url,method:p.method&&p.method.toUpperCase()||"GET",callbackContextCreated:!1,cbTime:0,recordFirstLoad:kt.recordFirstLoad,data:{}}).data={url:f.url,requestId:f.requestId,recordFirstLoad:f.recordFirstLoad},Ie(f,a),f.context&&(f.cid=f.context.id),f.r=m()%1e9,p.header=p.header||{},qe(p,f),r=p.success,i=p.fail,l=p.complete,p.success=le(function(){var t;if(f.end||(f.end=m()),ve(f),r){var e=m();try{t=r.apply(this,arguments)}finally{var n=m()-e;0<n&&(f.cbTime+=n)}}return t}),p.fail=le(function(){var t;if(f.end||(f.end=m()),ve(f),i){var e=m();try{t=i.apply(this,arguments)}finally{var n=m()-e;0<n&&(f.cbTime+=n)}}return t}),p.complete=le(function(t){var e,n;f.end||(f.end=m()),f.statusCode=y(t);var a=tt[F];if(a&&g(a))try{var r=a.apply(this,arguments);T(r)&&(n={custom:r})}catch(t){}if(ve(f),l){var i=m();try{e=l.apply(this,arguments)}finally{var s=m()-i;0<s&&(f.cbTime+=s)}}var o,c=t,u=!1;400<=(c=c||{}).statusCode&&(tt.ignoreErrorCodes||[]).indexOf(c.statusCode)<0?(u=!0,o=c.data,f.failMessage=O(o,tt.requestFailMessageSize)):c.errMsg&&!c.statusCode&&(u=!0,f.failMessage=c.errMsg.substring(0,tt.requestFailMessageSize)),u&&!kt.netError&&(kt.netError=!0);var d=xe(c,f),h=be(f,p,c);return f.context&&(f.context.dataComposed=!0),Object.assign(f.data,h,d||{},n||{}),ge(),e}),f.start=e,a&&(a.updateRemain(1),a.requests.push(f.data))),Te.apply(this,arguments)};function Ee(){Object.defineProperty(i,"request",{configurable:!0,enumerable:!0,writable:!0,value:ke})}function Ae(t){return t}function Oe(t,e){s.uid=t,r(C,t)}function _e(){return v.context}var Ce,Fe={version:"1.3.8",setUser:Oe,hookApp:Gt,hookPage:me,hookComponent:Ae,request:ke,getContext:_e},Le=["success","fail"],Re=[],Me={requestPayment:{fail:function(t){var e=arguments&&t,n="fail";return e&&T(e)&&"requestPayment:fail cancel"===e.errMsg&&(n="cancel"),n}}};function Pe(){(Ce=tt.hookApis||e()).forEach(function(t){-1<Re.indexOf(t)||"request"===t||Re.push(t)})}function Ne(t){return{apiId:t.apiId,type:N,name:t.name,success:t.success||0,fail:t.fail||0,cancel:t.cancel||0,start:t.start,end:t.end,duration:0<t.end-t.start?t.end-t.start:0,count:1,failMessage:t.failMessage||"",cid:t.cid}}function we(t,e){var n;t.context||(n="".concat(t.name,"-").concat(t.apiId),t.context=new oe({parent:e,name:n,type:N,data:t.data}))}function je(r){var n=i[r];return function(){var t=arguments[0]||{},e=v.context,a={apiId:++kt.apiId,name:r,data:{}};return we(a,e),a.context&&(a.cid=a.context.id),Le.forEach(function(n){t[n]=le(D(t[n],function(){var t,e;a.end||(a.end=m()),ve(a),(t=Me[r]&&Me[r][n]&&g(Me[r][n])?Me[r][n].apply(this,arguments):n)&&(a[t]=1),"fail"===t&&(e=arguments&&arguments[0],a.failMessage=O(e,tt.apiFailMessageSize))}))}),t.complete=le(q(t.complete,function(){a.end||(a.end=m()),ve(a)},function(){Object.assign(a.data,Ne(a)),a.context&&(a.context.dataComposed=!0),ge()})),e&&(e.updateRemain(1,N),e.apis.push(a.data)),a.start=m(),n.apply(this,arguments)}}function He(t){t&&i[t]&&Object.defineProperty(i,t,{configurable:!0,enumerable:!0,writable:!0,value:je(t)})}function ze(){Ce||Pe();var e={};return Re.forEach(function(t){e[t]=je(t)}),e}function Ye(){Ce||Pe(),Re.forEach(function(t){He(t)})}function Be(t){t&&!Yt()||(Ut(),ye(),Ee(),Ye()),t&&Object.assign(Fe,ze()||{})}function Ke(t){var e;at()||(nt(t||{}),rt(!0),gt(),e=!0,null!=tt.plugin&&(e=tt.plugin),Be(e))}function Ge(){return Fe.config=Ke,Fe}i.onNetworkStatusChange(function(t){s.networkType=t.networkType});var Ue=Ge();module.exports=Ue;